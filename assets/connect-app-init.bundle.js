(()=>{var G;function ee(n){if(G)throw new Error("Global Provider is already set");G=n}function f(n){if(!G)throw new Error(n??"Attempted to get Global AmazonConnectProvider that has not been set.");return G}function V(n){if(typeof n!="object"||n===null)return!1;let e=n;return!(typeof e.id!="string"||!("config"in e)||typeof e.getProxy!="function")}var m=class n extends Error{constructor({reason:e,namespace:t,errorKey:r,details:o}){super(`ConnectError with error key "${r}"`),this.errorType=n.ErrorType,this.namespace=t,this.errorKey=r,this.reason=e,this.details=o??{}}};m.ErrorType="ConnectError";function b(n){try{return structuredClone(n)}catch{try{return JSON.parse(JSON.stringify(n))}catch(t){throw new m({errorKey:"deepCloneFailed",details:{actualError:t}})}}}var k=class{constructor({provider:e,loggerKey:t}){this.events=new Map,this.logger=new l({provider:e,source:"emitter",mixin:()=>({emitterLoggerKey:t})})}on(e,t){let r=this.events.get(e);r?r.add(t):this.events.set(e,new Set([t]))}off(e,t){let r=this.events.get(e);r&&(r.delete(t),r.size<1&&this.events.delete(e))}getHandlers(e){var t;return Array.from((t=this.events.get(e))!==null&&t!==void 0?t:[])}};var ue=function(n,e,t,r){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{d(r.next(a))}catch(u){s(u)}}function p(a){try{d(r.throw(a))}catch(u){s(u)}}function d(a){a.done?i(a.value):o(a.value).then(c,p)}d((r=r.apply(n,e||[])).next())})},H=class extends k{emit(e,t){return ue(this,void 0,void 0,function*(){let r=this.getHandlers(e);yield Promise.allSettled(r.map(o=>ue(this,void 0,void 0,function*(){try{yield o(t)}catch(i){this.logger.error("An error occurred when invoking event handler",{error:i,parameter:e})}})))})}};function te(n){let e=new Uint8Array(Math.ceil(n/2));return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("").substring(0,n)}function w(){return"randomUUID"in crypto?crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>{let e=parseInt(n);return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})}function j(n,e){return{request:(t,r)=>n.request(e,t,r),subscribe:(t,r)=>n.subscribe(Object.assign(Object.assign({},t),{namespace:e}),r),unsubscribe:(t,r)=>n.unsubscribe(Object.assign(Object.assign({},t),{namespace:e}),r),getProxyInfo:()=>({connectionStatus:n.connectionStatus,proxyType:n.proxyType}),onConnectionStatusChange:t=>n.onConnectionStatusChange(t),offConnectionStatusChange:t=>n.offConnectionStatusChange(t)}}var W=class{constructor(){this.idsByHandler=new Map,this.handlersById=new Map}add(e){let t=this.idsByHandler.get(e);if(t)return{handlerId:t};let r=w();return this.idsByHandler.set(e,r),this.handlersById.set(r,e),{handlerId:r}}getIdByHandler(e){var t;return(t=this.idsByHandler.get(e))!==null&&t!==void 0?t:null}getHandlerById(e){var t;return(t=this.handlersById.get(e))!==null&&t!==void 0?t:null}get(){return[...this.idsByHandler.entries()].map(([e,t])=>({handler:e,handlerId:t}))}delete(e){let t=this.idsByHandler.get(e);return t&&this.handlersById.delete(t),this.idsByHandler.delete(e),{isEmpty:this.idsByHandler.size<1}}size(){return this.idsByHandler.size}};var M=class{constructor(){this.simpleSubscriptions=new Map,this.paramSubscriptions=new Map}add({namespace:e,key:t,parameter:r},o){var i,s,c,p,d;if(r){if(!this.paramSubscriptions.has(e)){this.paramSubscriptions.set(e,new Map([[t,new Map([[r,o]])]]));return}if(!(!((i=this.paramSubscriptions.get(e))===null||i===void 0)&&i.has(t))){(s=this.paramSubscriptions.get(e))===null||s===void 0||s.set(t,new Map([[r,o]]));return}(p=(c=this.paramSubscriptions.get(e))===null||c===void 0?void 0:c.get(t))===null||p===void 0||p.set(r,o)}else if(this.simpleSubscriptions.has(e))(d=this.simpleSubscriptions.get(e))===null||d===void 0||d.set(t,o);else{this.simpleSubscriptions.set(e,new Map([[t,o]]));return}}delete({namespace:e,key:t,parameter:r}){var o,i,s,c;r?!((i=(o=this.paramSubscriptions.get(e))===null||o===void 0?void 0:o.get(t))===null||i===void 0)&&i.delete(r)&&this.paramSubscriptions.get(e).get(t).size<1&&((s=this.paramSubscriptions.get(e))===null||s===void 0||s.delete(t),this.paramSubscriptions.get(e).size<1&&this.paramSubscriptions.delete(e)):!((c=this.simpleSubscriptions.get(e))===null||c===void 0)&&c.delete(t)&&this.simpleSubscriptions.get(e).size<1&&this.simpleSubscriptions.delete(e)}get({namespace:e,key:t,parameter:r}){var o,i,s;return r?(s=(i=this.paramSubscriptions.get(e))===null||i===void 0?void 0:i.get(t))===null||s===void 0?void 0:s.get(r):(o=this.simpleSubscriptions.get(e))===null||o===void 0?void 0:o.get(t)}getOrAdd(e,t){let r=this.get(e);return r||(r=t(),this.add(e,r)),r}addOrUpdate(e,t,r){let o=this.get(e);return o?o=r(o):o=t(),this.add(e,o),o}getAllSubscriptions(){let e=Array.from(this.simpleSubscriptions.keys()).flatMap(r=>Array.from(this.simpleSubscriptions.get(r).keys()).flatMap(o=>({namespace:r,key:o}))),t=Array.from(this.paramSubscriptions.keys()).flatMap(r=>Array.from(this.paramSubscriptions.get(r).keys()).flatMap(o=>Array.from(this.paramSubscriptions.get(r).get(o).keys()).flatMap(i=>({namespace:r,key:o,parameter:i}))));return[...e,...t]}};var D=class{constructor(){this.subscriptions=new M}add(e,t){return this.subscriptions.getOrAdd(e,()=>new W).add(t)}get(e){var t,r;return(r=(t=this.subscriptions.get(e))===null||t===void 0?void 0:t.get())!==null&&r!==void 0?r:[]}getById(e,t){var r,o;return(o=(r=this.subscriptions.get(e))===null||r===void 0?void 0:r.getHandlerById(t))!==null&&o!==void 0?o:null}delete(e,t){var r,o;(o=(r=this.subscriptions.get(e))===null||r===void 0?void 0:r.delete(t).isEmpty)!==null&&o!==void 0&&o&&this.subscriptions.delete(e)}size(e){var t,r;return(r=(t=this.subscriptions.get(e))===null||t===void 0?void 0:t.size())!==null&&r!==void 0?r:0}isEmpty(e){return this.size(e)===0}getAllSubscriptions(){return this.subscriptions.getAllSubscriptions()}getAllSubscriptionHandlerIds(){return this.subscriptions.getAllSubscriptions().reduce((e,t)=>e.concat(this.get(t).map(({handlerId:r})=>({topic:t,handlerId:r}))),[])}};var R=class{constructor({sendMetric:e,metricName:t,metricOptions:r}){this.unit="Milliseconds",this.sendMetric=e,this.startTime=performance.now(),this.metricName=t,this.dimensions=r?.dimensions?r.dimensions:{},this.optionalDimensions=r?.optionalDimensions?r.optionalDimensions:{}}stopDurationCounter(){let e=Math.round(performance.now()-this.startTime);return this.sendMetric({metricName:this.metricName,unit:this.unit,value:e,dimensions:this.dimensions,optionalDimensions:this.optionalDimensions}),{duration:e}}};function pe(n,e){if(Object.keys(n).length+Object.keys(e??{}).length>30)throw new Error("Cannot add more than 30 dimensions to a metric")}function re({metricData:n,time:e,namespace:t},r){var o,i;return{type:"metric",namespace:t,metricName:n.metricName,unit:n.unit,value:n.value,time:e,dimensions:(o=n.dimensions)!==null&&o!==void 0?o:{},optionalDimensions:(i=n.optionalDimensions)!==null&&i!==void 0?i:{},messageOrigin:r}}var P=class{constructor(e){this._proxy=null,this.namespace=e.namespace,e.provider&&typeof e.provider=="function"?this.providerFactory=e.provider:this.provider=e.provider}recordSuccess(e,t){var r;let o=Object.assign({},(r=t?.dimensions)!==null&&r!==void 0?r:{}),i=Object.assign(Object.assign({},t),{dimensions:o});this.recordCount(e,0,i)}recordError(e,t){var r;let o=Object.assign({},(r=t?.dimensions)!==null&&r!==void 0?r:{}),i=Object.assign(Object.assign({},t),{dimensions:o});this.recordCount(e,1,i)}recordCount(e,t,r){this.sendMetric({metricName:e,unit:"Count",value:t,dimensions:r?.dimensions,optionalDimensions:r?.optionalDimensions})}startDurationCounter(e,t){return new R({sendMetric:this.sendMetric.bind(this),metricName:e,metricOptions:t})}sendMetric({metricName:e,unit:t,value:r,dimensions:o,optionalDimensions:i}){o&&pe(o,i);let s={metricName:e,unit:t,value:r,dimensions:o,optionalDimensions:i},c=new Date;this.getProxy().sendMetric({metricData:s,time:c,namespace:this.namespace})}getProvider(){return this.provider||(this.provider=this.providerFactory?this.providerFactory():f()),this.provider}getProxy(){return this._proxy||(this._proxy=this.getProvider().getProxy()),this._proxy}};var Pe="clientTimeout";function $(n,e){let{namespace:t,command:r,data:o}=n;return{namespace:t,reason:"Client Timeout",details:{command:r,requestData:o,timeoutMs:e},errorKey:Pe}}var Te=30*1e3;function ge(n,e,t,r){let o=Math.max(1,r??Te);return new Promise((i,s)=>{let c=!1,p=setTimeout(()=>{t({timeoutMs:o,request:n}),s($(n,o)),c=!0},o);e(a=>{clearTimeout(p),c||(a.isError?s(new m(a)):i(a.data))})})}var L=class{constructor(e){this.requestMap=new Map,this.logger=new l({provider:e,source:"core.requestManager"})}processRequest(e){let{requestId:t}=e;return ge(e,r=>this.requestMap.set(t,r),({request:r,timeoutMs:o})=>this.handleTimeout(r,o))}processResponse(e){let{requestId:t}=e,r=this.requestMap.get(t);if(!r){this.logger.error("Returned a response message with no handler",{message:e});return}r(e),this.requestMap.delete(t)}handleTimeout(e,t){let{requestId:r,namespace:o,command:i}=e;this.requestMap.delete(r),this.logger.error("Client request timeout",{requestId:r,namespace:o,command:i,timeoutMs:t})}};function ne(n,e,t,r){let o=w();return{type:"request",namespace:n,command:e,requestId:o,data:t,messageOrigin:r}}var fe=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,r=Object.getOwnPropertySymbols(n);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(n,r[o])&&(t[r[o]]=n[r[o]]);return t};function z(n){try{switch(n.type){case"acknowledge":case"error":case"childConnectionClose":return n;case"childDownstreamMessage":return Object.assign(Object.assign({},n),{message:z(n.message)});case"publish":{let{data:e}=n,t=fe(n,["data"]);return Object.assign({},t)}case"response":{if(n.isError)return Object.assign(Object.assign({},n),{details:{command:n.details.command}});{let{data:e}=n,t=fe(n,["data"]);return Object.assign({},t)}}default:return n}}catch(e){return{messageDetails:"error when sanitizing downstream message",message:n,error:e}}}var J=class{constructor(e,t){this.provider=e,this.relayChildUpstreamMessage=t,this.channels=new Map,this.logger=new l({provider:e,source:"childConnectionManager"})}addChannel(e){let{connectionId:t}=e;if(this.channels.has(t)){this.logger.error("Attempted to add child connection that already exists. No action",{connectionId:t});return}e.type==="iframe"?this.setupIframe(e):this.setupComponent(e),this.logger.debug("Child channel added",{connectionId:t,type:e.type})}updateChannelPort(e){let{connectionId:t}=e,r=this.channels.get(t);if(!r){this.logger.error("Attempted to update child connection that does not exist No action",{connectionId:t});return}if(r.type==="component"){this.logger.error("Attempted to update a component channel connection as MessagePort. This is not supported.",{connectionId:t});return}let o=r;o.port.onmessage=null,o.port.close();let i=Object.assign(Object.assign({},e),{type:"iframe"});this.setupIframe(i),this.logger.info("Updated child port",{connectionId:t})}setupIframe(e){let{connectionId:t,port:r,providerId:o}=e,i=this.createMessageHandler(t,o);r.addEventListener("message",i),r.start(),this.channels.set(t,{type:"iframe",port:r,handler:i,providerId:o}),this.relayChildUpstreamMessage({type:"childUpstream",connectionId:t,sourceProviderId:o,parentProviderId:this.provider.id,message:{type:"childConnectionReady"}})}setupComponent(e){let{connectionId:t,providerId:r,sendDownstreamMessage:o,setUpstreamMessageHandler:i}=e;i(c=>{this.relayChildUpstreamMessage({type:"childUpstream",sourceProviderId:r,parentProviderId:this.provider.id,connectionId:t,message:c})}),this.channels.set(t,{type:"component",providerId:r,sendDownstreamMessage:o,setUpstreamMessageHandler:i}),this.relayChildUpstreamMessage({type:"childUpstream",connectionId:t,sourceProviderId:r,parentProviderId:this.provider.id,message:{type:"childConnectionReady"}})}handleDownstreamMessage({connectionId:e,message:t,targetProviderId:r}){let o=this.channels.get(e);if(!o){this.logger.warn("Attempted to route downstream message to child channel that does not exist",{connectionId:e,message:z(t)});return}let{providerId:i}=o;if(i&&i!==r){this.logger.error("Downstream target message did not match target provider id. Not sending message.",{connectionId:e,targetProviderId:r,actualProviderId:i,message:z(t)});return}o.type==="iframe"?o.port.postMessage(t):o.sendDownstreamMessage(t)}handleCloseMessage({connectionId:e}){let t=this.channels.get(e);if(!t){this.logger.warn("Attempted to close child channel that was not found",{connectionId:e});return}if(t.type==="iframe"){let{port:r,handler:o}=t;r.removeEventListener("message",o),r.close()}this.channels.delete(e),this.logger.debug("Removed child channel",{connectionId:e,type:t.type})}createMessageHandler(e,t){return r=>this.relayChildUpstreamMessage({type:"childUpstream",sourceProviderId:t,parentProviderId:this.provider.id,connectionId:e,message:r.data})}};var N=class{constructor(e){this.errorHandlers=new Set,this.logger=new l({provider:e,source:"core.proxy.error"})}invoke(e){let{message:t,key:r,details:o,isFatal:i,connectionStatus:s}=e;this.logger.error(t,{key:r,details:o,isFatal:i,connectionStatus:s},{duplicateMessageToConsole:!0,remoteIgnore:!0}),[...this.errorHandlers].forEach(c=>{try{c(e)}catch(p){this.logger.error("An error occurred within a AmazonConnectErrorHandler",{handlerError:p,originalError:e})}})}onError(e){this.errorHandlers.add(e)}offError(e){this.errorHandlers.delete(e)}};var T=class n{constructor({provider:e,sendHealthCheck:t,getUpstreamMessageOrigin:r}){this.connectionId=null,this.healthCheckInterval=null,this.healthCheckTimeout=null,this.sendHealthCheck=t,this.getUpstreamMessageOrigin=r,this.sendHealthCheckInterval=null,this.lastHealthCheckResponse=null,this._status="unknown",this.logger=new l({source:"core.proxy.health-check",provider:e,mixin:()=>({connectionId:this.connectionId})}),this.events=new H({provider:e,loggerKey:"core.proxy.health-check"})}get status(){return this._status}get isRunning(){return this.sendHealthCheckInterval!==null}get lastCheckCounter(){var e,t;return(t=(e=this.lastHealthCheckResponse)===null||e===void 0?void 0:e.counter)!==null&&t!==void 0?t:null}get lastCheckTime(){var e,t;return(t=(e=this.lastHealthCheckResponse)===null||e===void 0?void 0:e.time)!==null&&t!==void 0?t:null}start({healthCheckInterval:e,connectionId:t}){if(this.connectionId=t,this.healthCheckInterval=e,this.clearInterval(),e<=0){this.logger.debug("Health check disabled");return}if(e<1e3){this.logger.error("Health check interval is less than 1 second. Not running",{interval:e});return}this.sendHealthCheckMessage(),this.sendHealthCheckInterval=setInterval(()=>this.sendHealthCheckMessage(),e),this.startTimeout()}stop(){this.clearInterval(),this.clearTimeout()}handleResponse(e){this.setHealthy({time:e.time,counter:e.counter})}sendHealthCheckMessage(){this.sendHealthCheck({type:"healthCheck",messageOrigin:this.getUpstreamMessageOrigin()})}startTimeout(){if(!this.healthCheckInterval){this.logger.error("Health check interval not set. Cannot start timeout");return}this.clearTimeout(),this.healthCheckTimeout=setTimeout(()=>{this.setUnhealthy()},this.healthCheckInterval*3)}clearInterval(){this.sendHealthCheckInterval&&(clearInterval(this.sendHealthCheckInterval),this.sendHealthCheckInterval=null)}clearTimeout(){this.healthCheckTimeout&&(clearTimeout(this.healthCheckTimeout),this.healthCheckTimeout=null)}setUnhealthy(){if(this._status!=="unhealthy"){let e=this._status;this.logger.info("Connection unhealthy",{previousStatus:e}),this._status="unhealthy",this.emitStatusChanged("unhealthy",e)}}setHealthy(e){if(this.lastHealthCheckResponse=Object.assign({},e),this._status!=="healthy"){let t=this._status;this.logger.debug("Connection healthy",{previousStatus:t}),this._status="healthy",this.emitStatusChanged("healthy",t)}this.startTimeout()}emitStatusChanged(e,t){var r,o,i,s;this.events.emit(n.statusChangedKey,{status:e,previousStatus:t,lastCheckTime:(o=(r=this.lastHealthCheckResponse)===null||r===void 0?void 0:r.time)!==null&&o!==void 0?o:null,lastCheckCounter:(s=(i=this.lastHealthCheckResponse)===null||i===void 0?void 0:i.counter)!==null&&s!==void 0?s:null})}onStatusChanged(e){this.events.on(n.statusChangedKey,e)}offStatusChanged(e){this.events.off(n.statusChangedKey,e)}};T.statusChangedKey="statusChanged";var q=class{constructor(e){this.status="notConnected",this.changeHandlers=new Set,this.logger=new l({source:"core.proxy.connection-status-manager",provider:e,mixin:()=>({status:this.status})})}getStatus(){return this.status}update(e){this.status=e.status,this.logger.trace("Proxy Connection Status Changed",{status:e.status}),[...this.changeHandlers].forEach(t=>{try{t(e)}catch(r){this.logger.error("An error occurred within a ProxyConnectionChangedHandler",{error:r})}})}onChange(e){this.changeHandlers.add(e)}offChange(e){this.changeHandlers.delete(e)}};var He=function(n,e,t,r){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{d(r.next(a))}catch(u){s(u)}}function p(a){try{d(r.throw(a))}catch(u){s(u)}}function d(a){a.done?i(a.value):o(a.value).then(c,p)}d((r=r.apply(n,e||[])).next())})},je=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,r=Object.getOwnPropertySymbols(n);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(n,r[o])&&(t[r[o]]=n[r[o]]);return t},A=class{constructor(e){this.provider=e,this.logger=new l({source:"core.proxy",provider:e,mixin:()=>({proxyType:this.proxyType,connectionId:this.connectionId})}),this.requestManager=new L(e),this.status=new q(e),this.errorService=new N(e),this.upstreamMessageQueue=[],this.connectionEstablished=!1,this.isInitialized=!1,this.subscriptions=new D,this.connectionId=null,this.channelManager=new J(e,this.sendOrQueueMessageToSubject.bind(this)),this.healthCheck=new T({provider:e,sendHealthCheck:this.sendOrQueueMessageToSubject.bind(this),getUpstreamMessageOrigin:this.getUpstreamMessageOrigin.bind(this)})}init(){if(this.isInitialized)throw new Error("Proxy already initialized");this.isInitialized=!0,this.initProxy()}request(e,t,r,o){let i=ne(e,t,r,o??this.getUpstreamMessageOrigin()),s=this.requestManager.processRequest(i);return this.sendOrQueueMessageToSubject(i),s}subscribe(e,t,r){let{handlerId:o}=this.subscriptions.add(e,t),i={type:"subscribe",topic:e,messageOrigin:r??this.getUpstreamMessageOrigin(),handlerId:o};this.sendOrQueueMessageToSubject(i)}unsubscribe(e,t,r){if(this.subscriptions.delete(e,t),this.subscriptions.isEmpty(e)){let o={type:"unsubscribe",topic:e,messageOrigin:r??this.getUpstreamMessageOrigin()};this.sendOrQueueMessageToSubject(o)}}log(e){let t=oe(e,this.addContextToLogger(),this.getUpstreamMessageOrigin());this.sendOrQueueMessageToSubject(t)}sendLogMessage(e){if(e.type!=="log"){this.logger.error("Attempted to send invalid log message",{message:e});return}e.context=Object.assign(Object.assign({},e.context),this.addContextToLogger()),this.sendOrQueueMessageToSubject(e)}sendMetric({metricData:e,time:t,namespace:r}){let o=re({metricData:e,time:t,namespace:r},this.getUpstreamMessageOrigin());this.sendOrQueueMessageToSubject(o)}sendMetricMessage(e){if(e.type!=="metric"){this.logger.error("Attempted to send invalid metric message",{metricMessage:e});return}this.sendOrQueueMessageToSubject(e)}sendOrQueueMessageToSubject(e){this.connectionEstablished?this.sendMessageToSubject(e):this.upstreamMessageQueue.push(e)}consumerMessageHandler(e){if(!this.isInitialized){this.logger.error("Attempted to process message from subject prior to proxy being initializing. Message not processed",{originalMessageEventData:e.data});return}let{data:t}=e;if(!("type"in t)){this.logger.warn("Unknown inbound message",{originalMessageEventData:t});return}let r=t;this.handleMessageFromSubject(r)}handleMessageFromSubject(e){this.handleDefaultMessageFromSubject(e)}handleDefaultMessageFromSubject(e){switch(e.type){case"acknowledge":this.handleConnectionAcknowledge(e);break;case"response":this.handleResponse(e);break;case"publish":this.handlePublish(e);break;case"error":this.handleError(e);break;case"childDownstreamMessage":this.channelManager.handleDownstreamMessage(e);break;case"childConnectionClose":this.channelManager.handleCloseMessage(e);break;case"healthCheckResponse":this.healthCheck.handleResponse(e);break;default:this.logger.error("Unknown inbound message",{originalMessageEventData:e});return}}handleConnectionAcknowledge(e){for(this.connectionId=e.connectionId,this.logger.debug("Connection acknowledged by subject",{connectionId:e.connectionId,queuedMessageCount:this.upstreamMessageQueue.length,status:e.status}),this.status.update({status:"ready",connectionId:e.connectionId}),this.connectionEstablished=!0;this.upstreamMessageQueue.length;){let t=this.upstreamMessageQueue.shift();this.sendMessageToSubject(t)}this.healthCheck.start(e),this.logger.debug("Proxy connection ready",{connectionId:this.connectionId})}handleResponse(e){this.requestManager.processResponse(e)}handlePublish(e){let{handlerId:t,topic:r}=e;if(t){let o=this.subscriptions.getById(r,t);o&&this.handleAsyncSubscriptionHandlerInvoke({handler:o,handlerId:t},e)}else this.subscriptions.get(r).map(o=>{this.handleAsyncSubscriptionHandlerInvoke(o,e)})}handleError(e){if(e.isFatal){let{message:t,type:r}=e,o=je(e,["message","type"]);this.status.update({status:"error",reason:t,details:o})}this.publishError({message:e.message,key:e.key,details:e.details,isFatal:e.isFatal,proxyStatus:e.status})}publishError(e){let t=Object.assign(Object.assign({},e),{connectionStatus:this.connectionStatus});this.errorService.invoke(t)}handleAsyncSubscriptionHandlerInvoke(e,t){return He(this,arguments,void 0,function*({handler:r,handlerId:o},{topic:i,data:s}){try{yield r(s)}catch(c){this.logger.error("An error occurred when handling subscription",{topic:i,error:c,handlerId:o})}})}get connectionStatus(){return this.status.getStatus()}onError(e){this.errorService.onError(e)}offError(e){this.errorService.offError(e)}onConnectionStatusChange(e){this.status.onChange(e)}offConnectionStatusChange(e){this.status.offChange(e)}onHealthCheckStatusChanged(e){this.healthCheck.onStatusChanged(e)}offHealthCheckStatusChanged(e){this.healthCheck.offStatusChanged(e)}addChildChannel(e){this.addChildIframeChannel(e)}addChildIframeChannel(e){this.channelManager.addChannel(Object.assign(Object.assign({},e),{type:"iframe"}))}addChildComponentChannel(e){this.channelManager.addChannel(Object.assign(Object.assign({},e),{type:"component"}))}updateChildIframeChannelPort(e){this.channelManager.updateChannelPort(e)}updateChildChannelPort(e){this.updateChildIframeChannelPort(e)}getConnectionId(){return this.connectionId?Promise.resolve(this.connectionId):new Promise((e,t)=>{let r,o=i=>{i.status==="ready"&&(this.offConnectionStatusChange(o),clearInterval(r),e(i.connectionId))};r=setTimeout(()=>{this.logger.error("Timeout getting connection id"),this.offConnectionStatusChange(o),t(new Error("Timeout getting connectionId"))},10*1e3),this.onConnectionStatusChange(o)})}resetConnection(e){this.logger.debug("Resetting connection",{reason:e,connectionId:this.connectionId}),this.connectionEstablished=!1,this.status.update({status:"reset",reason:e});let{subscriptionHandlerCount:t}=this.restoreAllHandler();this.logger.info("Resetting proxy",{reason:e,subscriptionHandlerCount:t}),this.logger.debug("Connection reset complete, restoring handlers",{subscriptionHandlerCount:t})}restoreAllHandler(){var e;let t=this.subscriptions.getAllSubscriptionHandlerIds();return t?.map(({topic:r,handlerId:o})=>({type:"subscribe",topic:r,messageOrigin:this.getUpstreamMessageOrigin(),handlerId:o})).forEach(r=>this.sendOrQueueMessageToSubject(r)),{subscriptionHandlerCount:(e=t?.length)!==null&&e!==void 0?e:-1}}unsubscribeAllHandlers(){var e;let t=this.subscriptions.getAllSubscriptionHandlerIds();this.logger.info("Unsubscribing all handlers from proxy",{subscriptionHandlerCount:(e=t?.length)!==null&&e!==void 0?e:-1}),t?.map(({topic:r})=>({type:"unsubscribe",topic:r,messageOrigin:this.getUpstreamMessageOrigin()})).forEach(r=>this.sendOrQueueMessageToSubject(r))}};var U=class n{constructor(e,t){this.timeoutMs=t,this.onCancelled=e,this.timeout=setTimeout(()=>this.handleCancel(),this.timeoutMs),this.status="running",this.logger=new l({source:"core.utility.timeout-tracker",mixin:()=>({timeoutMs:this.timeoutMs,timeoutTrackerStatus:this.status})})}static start(e,t){return new n(e,t)}complete(){switch(this.status){case"running":return this.handleComplete();case"completed":return this.logger.debug("TimeoutTracker already marked complete. No action."),!0;case"cancelled":return this.logger.info("Attempted to complete a TimeoutTracker that has already been cancelled"),!1}}isCancelled(){return this.status==="cancelled"}getStatus(){return this.status}handleCancel(){switch(this.status){case"running":this.status="cancelled",this.logger.info("TimeoutTracker has timed out. Invoking onCancelled Handler"),this.invokeOnCancelled();break;case"completed":this.logger.debug("Cancel operation for TimerTracker invoked after already completed. No action.");break;default:throw new Error("Cancel operation in TimerTracker called during an unexpected time.")}}handleComplete(){return this.status="completed",clearTimeout(this.timeout),!0}invokeOnCancelled(){try{this.onCancelled({timeoutMs:this.timeoutMs})}catch(e){this.logger.error("Error when attempting to invoke TimeoutTrackerCancelledHandler",{error:e})}}};var h;(function(n){n[n.trace=1]="trace",n[n.debug=2]="debug",n[n.info=3]="info",n[n.warn=4]="warn",n[n.error=5]="error"})(h||(h={}));function ie(n,e,t){if(t)switch(n){case h.error:console.error(e,t);break;case h.warn:console.warn(e,t);break;case h.info:console.info(e,t);break;case h.debug:console.debug(e,t);break;case h.trace:console.trace(e,t);break;default:console.log(e,t);break}else switch(n){case h.error:console.error(e);break;case h.warn:console.warn(e);break;case h.info:console.info(e);break;case h.debug:console.debug(e);break;case h.trace:console.trace(e);break;default:console.log(e);break}}var B=class{constructor(e){this.mixin=e}getTransformedData(e,t){return this.mixin?Object.assign(Object.assign({},t??{}),this.mixin(t??{},e)):t}};var l=class{constructor(e){this._proxy=null,this._logToConsoleLevel=null,this.loggerId=te(8),typeof e=="string"?(this.source=e,this.dataTransformer=new B(void 0)):(this.source=e.source,e.provider&&typeof e.provider=="function"?this.providerFactory=e.provider:this.provider=e.provider,this.dataTransformer=new B(e.mixin),this.logOptions=e.options)}trace(e,t,r){this.log(h.trace,e,t,r)}debug(e,t,r){this.log(h.debug,e,t,r)}info(e,t,r){this.log(h.info,e,t,r)}warn(e,t,r){this.log(h.warn,e,t,r)}error(e,t,r){this.log(h.error,e,t,r)}log(e,t,r,o){let i=this.dataTransformer.getTransformedData(e,r);this.ignoreRemote(o)||this.getProxy().log({level:e,source:this.source,loggerId:this.loggerId,message:t,data:i}),this.applyDuplicateMessageToConsole(e,o)&&ie(e,t,i)}getProvider(){return this.provider||(this.provider=this.providerFactory?this.providerFactory():f()),this.provider}getProxy(){return this._proxy||(this._proxy=this.getProvider().getProxy()),this._proxy}applyDuplicateMessageToConsole(e,t){return t?.duplicateMessageToConsole||this.getLogConsoleLevel()<=e}getLogConsoleLevel(){var e,t,r,o;return this._logToConsoleLevel||(this._logToConsoleLevel=!((e=this.logOptions)===null||e===void 0)&&e.minLogToConsoleLevelOverride?this.logOptions.minLogToConsoleLevelOverride:(o=(r=(t=this.getProvider().config)===null||t===void 0?void 0:t.logging)===null||r===void 0?void 0:r.minLogToConsoleLevel)!==null&&o!==void 0?o:h.error),this._logToConsoleLevel}ignoreRemote(e){var t,r,o;return((r=(t=this.logOptions)===null||t===void 0?void 0:t.remoteIgnore)!==null&&r!==void 0?r:!1)||((o=e?.remoteIgnore)!==null&&o!==void 0?o:!1)}};function me(n){if(n)try{return b(n)}catch{return{error:"Data failed to sanitize. The original data is not available"}}}function oe({level:n,source:e,message:t,loggerId:r,data:o},i,s){let c=me(o);return{type:"log",level:n,time:new Date,source:e,message:t,loggerId:r,data:c,context:i,messageOrigin:s}}var x=class{constructor({config:e,proxyFactory:t}){if(this._id=w(),!t)throw new Error("Attempted to get Proxy before setting up factory");if(!e)throw new Error("Failed to include config");this.proxyFactory=t,this._config=e}get id(){return this._id}getProxy(){return this.proxy||(this.proxy=this.proxyFactory(this),this.proxy.init()),this.proxy}get config(){return Object.assign({},this._config)}onError(e){this.getProxy().onError(e)}offError(e){this.getProxy().offError(e)}static initializeProvider(e){if(this.isInitialized){let t="Attempted to initialize provider more than one time.",r={};try{let o=f();new l({source:"core.amazonConnectProvider.init",provider:o}).error(t)}catch(o){r.loggingError=o?.message}throw new m({errorKey:"attemptInitializeMultipleProviders",reason:t,details:r})}return ee(e),this.isInitialized=!0,e.getProxy(),e}};x.isInitialized=!1;var _=class{constructor(e,t){this.engineContext=e,this.moduleNamespace=t}get proxy(){if(!this.moduleProxy){let e=this.engineContext.getProvider().getProxy(),t=this.moduleNamespace;this.moduleProxy=j(e,t)}return this.moduleProxy}getProvider(){return this.engineContext.getProvider()}createLogger(e){return typeof e=="object"?new l(Object.assign(Object.assign({},e),{provider:()=>this.engineContext.getProvider()})):new l({source:e,provider:()=>this.engineContext.getProvider()})}createMetricRecorder(e){return typeof e=="object"?new P(Object.assign(Object.assign({},e),{provider:()=>this.engineContext.getProvider()})):new P({namespace:e,provider:()=>this.engineContext.getProvider()})}};var y=class{constructor(e){this._provider=e}getProvider(){return this._provider?this._provider:f()}getModuleContext(e){return new _(this,e)}};function ye({namespace:n,config:e}){return e&&"context"in e&&e.context?e.context:V(e)?new y(e).getModuleContext(n):new y(e?.provider).getModuleContext(n)}var S=class{constructor(e,t){this.namespace=e,this.context=ye({namespace:e,config:t})}};var se="1.0.9";var E=class extends y{constructor({provider:e,instanceId:t,config:r,parameters:o,contactScope:i,scope:s,launchedBy:c}){super(e),this.appInstanceId=t,this.instanceId=t,this.config=r,this.appConfig=r,this.contactScope=i,this.scope=s,this.parameters=o,this.launchedBy=c??{type:"unknown"}}};var ve=function(n,e,t,r){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{d(r.next(a))}catch(u){s(u)}}function p(a){try{d(r.throw(a))}catch(u){s(u)}}function d(a){a.done?i(a.value):o(a.value).then(c,p)}d((r=r.apply(n,e||[])).next())})},Q=class{constructor(e){this.provider=e,this.state={isRunning:!1},this.isCreated=!1,this.isDestroyed=!1,this.logger=new l({source:"app.lifecycleManager",provider:e,mixin:()=>({state:this.state,isCreated:this.isCreated,isDestroyed:this.isDestroyed})})}get appState(){return Object.assign({},this.state)}handleCreate(e){return ve(this,void 0,void 0,function*(){var t;if(this.isDestroyed){this.logger.error("An attempt was Create after a Destroy. No Action",{instanceId:e.context.instanceId});return}if(this.isCreated){this.logger.error("An attempt was invoke Create after it was already invoked. No Action",{instanceId:e.context.instanceId});return}if(this.logger.debug("Begin Lifecycle Create",{instanceId:e.context.instanceId}),!(!((t=this.provider.config)===null||t===void 0)&&t.onCreate)){let o="App did not specify an onCreated handler. This is required. Closing app",i={appInstanceId:e.context.instanceId,instanceId:e.context.instanceId};this.logger.error(o,{instanceId:e.context.instanceId}),this.provider.sendFatalError(o,i);return}let{success:r}=yield this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"create"}),o=>this.provider.config.onCreate(o),!0);r&&(this.isCreated=!0,this.sendLifecycleHandlerCompletedMessage(e.context.instanceId,"create"))})}handleLifecycleChange(e,t,r){return ve(this,void 0,void 0,function*(){let o=!1;try{yield t(e),o=!0}catch(i){let{instanceId:s}=e.context;if(r){let c=`An fatal error occurred when handling a ${e.stage} lifecycle action. Closing app`;this.logger.error(c,{instanceId:s,error:i}),this.provider.sendFatalError(c,i)}else this.logger.error(`An error occurred when handling a ${e.stage} lifecycle action.`,{instanceId:s,error:i})}return{success:o}})}sendLifecycleHandlerCompletedMessage(e,t){this.logger.debug(`Sending lifecycle ${t} completed signal`),this.provider.getProxy().sendLifecycleHandlerCompleted(e,t)}};var ae=function(n,e,t,r){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{d(r.next(a))}catch(u){s(u)}}function p(a){try{d(r.throw(a))}catch(u){s(u)}}function d(a){a.done?i(a.value):o(a.value).then(c,p)}d((r=r.apply(n,e||[])).next())})},X=class extends Q{constructor(e){super(e),this.startHandlers=new Set,this.stopHandlers=new Set}handleLifecycleChangeMessage(e){let t=new E({provider:this.provider,instanceId:e.instanceId,config:e.config,parameters:e.parameters,contactScope:e.contactScope,scope:e.scope,launchedBy:e.launchedBy});this.state.instanceId=e.instanceId,this.state.appInstanceId=e.instanceId,this.state.config=e.config,this.state.appConfig=e.config,this.state.contactScope=e.contactScope;let r={context:t};switch(e.stage){case"create":return this.handleCreate(r);case"start":return this.handleStart(r);case"stop":return this.handleStop(r);case"destroy":return this.handleDestroy(r)}}onStart(e,t){this.startHandlers.add(e),t?.invokeIfRunning&&this.state.isRunning&&this.handleLifecycleChange(Object.assign(Object.assign({},this.getAppLifecycleChangeParams()),{stage:"start"}),r=>e(r),!1)}onStop(e){this.stopHandlers.add(e)}offStart(e){this.startHandlers.delete(e)}offStop(e){this.stopHandlers.delete(e)}handleStart(e){return ae(this,void 0,void 0,function*(){if(this.isDestroyed){this.logger.error("An attempt was Start after a Destroy. No Action",{appInstanceId:e.context.instanceId});return}if(!this.isCreated){this.logger.error("An attempt was invoke Start before Create. No Action",{appInstanceId:e.context.instanceId});return}this.state.isRunning=!0,this.logger.info("Begin Lifecycle Start");let t=yield Promise.all([...this.startHandlers].map(r=>this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"start"}),o=>r(o),!1)));this.logger.debug("Completed all start handlers",{count:this.startHandlers.size,errorCount:t.filter(({success:r})=>!r).length})})}handleStop(e){return ae(this,void 0,void 0,function*(){if(this.isDestroyed){this.logger.error("An attempt was Stop after a Destroy. No Action",{appInstanceId:e.context.instanceId});return}if(!this.isCreated){this.logger.error("An attempt was invoke Stop before Create. No Action",{appInstanceId:e.context.instanceId});return}this.state.isRunning=!1,this.logger.info("Begin Lifecycle Stop");let t=yield Promise.all([...this.stopHandlers].map(r=>this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"stop"}),o=>r(o),!1)));this.logger.debug("Completed all stop handlers",{count:this.stopHandlers.size,errorCount:t.filter(({success:r})=>!r).length})})}handleDestroy(e){return ae(this,void 0,void 0,function*(){if(this.isDestroyed){this.logger.error("An attempt was invoke Destroy multiple times. No Action",{appInstanceId:e.context.instanceId});return}if(!this.isCreated){this.logger.error("An attempt was invoke Destroy before Create. No Action",{appInstanceId:e.context.instanceId});return}this.isDestroyed=!0,this.state.isRunning=!1,this.logger.info("Begin Lifecycle Destroy");let{config:t}=this.provider,{success:r}=yield this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"destroy"}),o=>t.onDestroy?t.onDestroy(o):Promise.resolve(),!0);r&&this.sendLifecycleHandlerCompletedMessage(e.context.instanceId,"destroy")})}getAppLifecycleChangeParams(){return{context:new E({provider:this.provider,instanceId:this.state.instanceId,config:this.state.config,contactScope:this.state.contactScope,scope:this.state.scope,parameters:this.state.parameters,launchedBy:this.state.launchedBy})}}};function xe(n){var e,t;return Math.max(1,Math.min(6e4,(t=(e=n.workspace)===null||e===void 0?void 0:e.connectionTimeout)!==null&&t!==void 0?t:5e3))}var O=class extends A{constructor(e,t){super(e),this.channel=new MessageChannel,this.lifecycleManager=t,this.appLogger=new l({source:"app.appProxy",provider:e})}get proxyType(){return"AppProxy"}sendLifecycleHandlerCompleted(e,t){let r={type:"appLifecycleHandlerCompleted",stage:t,appInstanceId:e};this.sendOrQueueMessageToSubject(r)}tryCloseApp(e,t,r){let o={type:"closeApp",isFatalError:t??!1,message:e,data:r};this.sendOrQueueMessageToSubject(o)}sendServiceError(e,t){let r={type:"serviceError",message:e,data:t};this.sendOrQueueMessageToSubject(r)}publish(e,t){let r={type:"appPublish",topic:e,data:t};this.sendOrQueueMessageToSubject(r)}initProxy(){let e={type:"connect-app-host-init",sdkVersion:se,providerId:this.provider.id};this.status.update({status:"initializing"}),this.channel.port1.onmessage=t=>this.consumerMessageHandler(t),this.connectionTimer=U.start(this.connectionTimeout.bind(this),xe(this.provider.config)),window.parent.postMessage(e,"*",[this.channel.port2]),this.appLogger.debug("Send connect message to configure proxy")}sendMessageToSubject(e){this.channel.port1.postMessage(e)}getUpstreamMessageOrigin(){if(document?.location){let{origin:e,pathname:t}=document.location;return{_type:"app",providerId:this.provider.id,origin:e,path:t}}else return{_type:"app",providerId:this.provider.id,origin:"unknown",path:"unknown"}}handleConnectionAcknowledge(e){if(!this.connectionTimer.complete()){this.appLogger.error("Workspace connection acknowledge received after timeout. App is not connected to workspace.",{timeout:this.connectionTimer.timeoutMs});return}super.handleConnectionAcknowledge(e)}handleMessageFromSubject(e){e.type==="appLifecycle"?this.lifecycleManager.handleLifecycleChangeMessage(e).catch(t=>{this.appLogger.error("An error occurred when invoking handleLifecycleChangeMessage",{error:t})}):super.handleMessageFromSubject(e)}connectionTimeout(e){this.status.update({status:"error",reason:"Workspace connection timeout",details:Object.assign({},e)}),this.publishError({message:"App failed to connect to workspace in the allotted time",key:"workspaceConnectTimeout",details:Object.assign({},e),isFatal:!0,proxyStatus:{initialized:!1}})}addContextToLogger(){let{isRunning:e}=this.lifecycleManager.appState;if(document?.location){let{origin:t,pathname:r}=document.location;return{appIsRunning:e,app:{origin:t,path:r}}}else return{appIsRunning:e,app:{origin:"unknown",path:"unknown"}}}};var F=class n extends x{constructor(e){super({config:e,proxyFactory:()=>this.createProxy()}),this.lifecycleManager=new X(this),this.logger=new l({provider:this,source:"app.provider"})}static init(e){let t=new n(e);return n.initializeProvider(t),{provider:t}}static get default(){return f("AmazonConnectApp has not been initialized")}createProxy(){return new O(this,this.lifecycleManager)}onStart(e,t){this.lifecycleManager.onStart(e,t)}onStop(e){this.lifecycleManager.onStop(e)}offStart(e){this.lifecycleManager.offStart(e)}offStop(e){this.lifecycleManager.offStop(e)}sendCloseAppRequest(e){this.getProxy().tryCloseApp(e,!1)}sendError(e,t){this.logger.error(e,t)}sendFatalError(e,t){this.getProxy().tryCloseApp(e,!0,t?b(t):void 0)}subscribe(e,t){this.getProxy().subscribe(e,t)}unsubscribe(e,t){this.getProxy().unsubscribe(e,t)}publish(e,t){this.getProxy().publish(e,b(t))}};var ce;(function(n){n.CurrentContactId="CURRENT_CONTACT"})(ce||(ce={}));var Y="aws.connect.contact";var g;(function(n){n.getARN="agent/getARN",n.getName="agent/getName",n.getState="agent/getState",n.getRoutingProfile="agent/getRoutingProfile",n.getChannelConcurrency="agent/getChannelConcurrency",n.getExtension="agent/getExtension",n.getDialableCountries="agent/getDialableCountries",n.setAvailabilityState="agent/setAvailabilityState",n.setAvailabilityStateByName="agent/setAvailabilityStateByName",n.setOffline="agent/setOffline",n.listAvailabilityStates="agent/listAvailabilityStates",n.listQuickConnects="agent/listQuickConnects"})(g||(g={}));var le;(function(n){n.getAttributes="contact/getAttributes",n.getInitialContactId="contact/getInitialContactId",n.getType="contact/getType",n.getStateDuration="contact/getStateDuration",n.getQueue="contact/getQueue",n.getQueueTimestamp="contact/getQueueTimestamp",n.getDescription="contact/getDescription",n.getReferences="contact/getReferences",n.getChannelType="contact/getChannelType",n.addParticipant="contact/addParticipant",n.transfer="contact/transfer",n.accept="contact/accept",n.clear="contact/clear",n.isPreviewMode="contact/isPreviewMode",n.getPreviewConfiguration="contact/getPreviewConfiguration",n.engagePreviewContact="contact/engagePreviewContact"})(le||(le={}));var de;(function(n){n.StartingACW="contact/acw",n.Connected="contact/connected",n.Destroyed="contact/destroy",n.Missed="contact/missed",n.Cleared="contact/cleared",n.Incoming="contact/incoming"})(de||(de={}));var v;(function(n){n.StateChanged="agent/stateChange",n.RoutingProfileChanged="agent/routingProfileChanged",n.EnabledChannelListChanged="agent/enabledChannelListChanged"})(v||(v={}));var be;be||(be={});var Z=function(n,e,t,r){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{d(r.next(a))}catch(u){s(u)}}function p(a){try{d(r.throw(a))}catch(u){s(u)}}function d(a){a.done?i(a.value):o(a.value).then(c,p)}d((r=r.apply(n,e||[])).next())})},I=class extends S{constructor(e){super(Y,e)}getARN(){return Z(this,void 0,void 0,function*(){let{ARN:e}=yield this.context.proxy.request(g.getARN);return e})}getName(){return Z(this,void 0,void 0,function*(){let{name:e}=yield this.context.proxy.request(g.getName);return e})}getState(){return this.context.proxy.request(g.getState)}getRoutingProfile(){return this.context.proxy.request(g.getRoutingProfile)}getChannelConcurrency(){return this.context.proxy.request(g.getChannelConcurrency)}getExtension(){return Z(this,void 0,void 0,function*(){let{extension:e}=yield this.context.proxy.request(g.getExtension);return e})}getDialableCountries(){return Z(this,void 0,void 0,function*(){let{dialableCountries:e}=yield this.context.proxy.request(g.getDialableCountries);return e})}onStateChanged(e){this.context.proxy.subscribe({key:v.StateChanged},e)}offStateChanged(e){this.context.proxy.unsubscribe({key:v.StateChanged},e)}setAvailabilityState(e){return this.context.proxy.request(g.setAvailabilityState,{agentStateARN:e})}setAvailabilityStateByName(e){return this.context.proxy.request(g.setAvailabilityStateByName,{agentStateName:e})}setOffline(){return this.context.proxy.request(g.setOffline,{})}listAvailabilityStates(){return this.context.proxy.request(g.listAvailabilityStates)}listQuickConnects(e,t){return this.context.proxy.request(g.listQuickConnects,{queueARNs:e,options:t})}onEnabledChannelListChanged(e){this.context.proxy.subscribe({key:v.EnabledChannelListChanged},e)}offEnabledChannelListChanged(e){this.context.proxy.unsubscribe({key:v.EnabledChannelListChanged},e)}onRoutingProfileChanged(e){this.context.proxy.subscribe({key:v.RoutingProfileChanged},e)}offRoutingProfileChanged(e){this.context.proxy.unsubscribe({key:v.RoutingProfileChanged},e)}};var we;we||(we={});var Me;Me||(Me={});console.log("\u2705 Entry file loaded");function he(n){let e=document.getElementById("app");e&&(e.textContent=n)}var C=null,K=!1,{provider:Se}=F.init({onCreate:async n=>{let e=n?.context?.appInstanceId;console.log("\u2705 App initialized. appInstanceId=",e);try{let t=new I,[r,o]=await Promise.all([t.getName(),t.getState()]);if(console.table({name:r,state:o}),he(`Agent: ${r} \xB7 Status: ${o?.name??o}`),C=({state:i})=>{let s=i?.name??i;console.log("\u{1F504} Agent state changed:",i),he(`Agent: ${r} \xB7 Status: ${s}`)},!K&&C)try{t.onStateChanged(C),K=!0,console.log("\u{1F4CC} Subscribed via AgentClient.onStateChanged")}catch(i){console.warn("AgentClient.onStateChanged not available; falling back to provider.subscribe",i),Se.subscribe({key:"agent/stateChange"},C),K=!0,console.log('\u{1F4CC} Subscribed via provider.subscribe({ key: "agent/stateChange" })')}}catch(t){console.error("Failed to initialize agent status watch:",t),he("Initialization error. See console.")}},onDestroy:()=>{if(console.log("\u{1F9F9} App being destroyed"),K&&C)try{new I().offStateChanged?.(C),Se.unsubscribe?.({key:"agent/stateChange"},C)}catch(n){console.warn("Unsubscribe encountered an issue (continuing):",n)}finally{K=!1,C=null}}});(async()=>{try{let n=new I,[e,t]=await Promise.all([n.getName(),n.getState()]);console.table({name:e,state:t})}catch(n){console.error("AgentClient failed:",n)}})();})();
