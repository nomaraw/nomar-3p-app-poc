
<!DOCTYPE html>
<html>
  <body style="font-family: system-ui, sans-serif; padding: 20px;">
    <h2>Nomar 3P App â€“ Heartbeat Test</h2>
    <div id="status">Loadingâ€¦</div>

    <script type="module">
      const status = (msg) => { document.getElementById('status').textContent = msg; };
      const log = (...a) => { console.log('[POC]', ...a); };

      // Must run inside the Amazon Connect Agent Workspace iframe per AWS docs. [1](https://deepwiki.com/amazon-connect/amazon-connect-chat-ui-examples/4.1-interactive-messages)
      const isEmbedded = window.top !== window;
      if (!isEmbedded) {
        status('âŒ Not running inside Agent Workspace. Open me from the Apps launcher.');
        log('Open this page via the Agent Workspace Apps launcher (Thirdâ€‘party application).');
        // Donâ€™t try to init outside Workspace â€“ itâ€™s expected to fail/time out (documented).
        // https://docs.aws.amazon.com/agentworkspace/latest/devguide/getting-started-initialize-sdk.html
        return;
      }

      // Try to import the SDK from two explicit ESM paths (no bundlers needed):
      async function loadSdk() {
        const candidates = [
          // jsDelivr serving the actual ESM file inside the package
          'https://cdn.jsdelivr.net/npm/@amazon-connect/app/lib-esm/index.js',
          // unpkg fallback for the same file
          'https://unpkg.com/@amazon-connect/app/lib-esm/index.js'
        ];

        for (const url of candidates) {
          try {
            log('Importing SDK from', url);
            const mod = await import(url);
            if (mod && typeof mod.AmazonConnectApp?.init === 'function') {
              return mod.AmazonConnectApp;
            }
            log('SDK import succeeded but AmazonConnectApp.init not found:', Object.keys(mod || {}));
          } catch (e) {
            log('Import failed from', url, e);
          }
        }
        return null;
      }

      (async () => {
        const sdk = await loadSdk();
        if (!sdk) {
          status('âŒ SDK failed to load (check Network tab; CDN may be blocked).');
          log('If CDN access is restricted, host a copy in your repo or use localhost per AWS docs.', 
              'Docs: Install the SDK from npm', 
              'https://docs.aws.amazon.com/agentworkspace/latest/devguide/getting-started-install-sdk.html');
          return;
        }

        try {
          // Initialize per AWS developer guide with lifecycle callbacks. [1](https://deepwiki.com/amazon-connect/amazon-connect-chat-ui-examples/4.1-interactive-messages)
          const { provider } = sdk.init({
            onCreate: (event) => {
              const { appInstanceId } = event?.context || {};
              log('ğŸ’š Workspace connection established. appInstanceId =', appInstanceId);
              status('ğŸ’š CONNECTED to Agent Workspace (heartbeat OK)');
            },
            onDestroy: () => {
              log('ğŸ”´ Workspace destroying app.');
            }
          });

          log('APP INIT OK', provider);
          // Minimal heartbeat proving the bridge is live (no telephony, no paid messaging).
          setInterval(() => log('heartbeat â†’ workspace'), 5000);

        } catch (err) {
          status('âŒ Init failed (see console).');
          console.error('INIT FAILED', err);
        }
      })();
    </script>
  </body>
</html>
